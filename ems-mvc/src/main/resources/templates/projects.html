<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Projects</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div class="container mt-5">
    <h2>Projects</h2>
    <div th:if="${message}" class="alert alert-success" th:text="${message}"></div>
    <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>

    <!-- Manager: Create Project Form -->
    <div th:if="${isManager}" class="card mb-4">
        <div class="card-header">Create New Project</div>
        <div class="card-body">
            <form th:action="@{/projects/create}" method="post" class="row g-2">
                <div class="col-md-4">
                    <input type="text" name="name" class="form-control" placeholder="Project Name" minlength="3" maxlength="50" required>
                </div>
                <div class="col-md-4">
                    <input type="text" name="description" class="form-control" placeholder="Project Description" maxlength="100" required>
                </div>
                <div class="col-md-2">
                    <select name="priority" class="form-select" required>
                        <option value="" disabled selected>Priority</option>
                        <option value="High">High</option>
                        <option value="Medium">Medium</option>
                        <option value="Low">Low</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary w-100">Create</button>
                </div>
            </form>
        </div>
    </div>

    <table class="table table-bordered mt-4">
        <thead class="table-dark">
        <tr>
            <th>Name</th>
            <th>Description</th>
            <th>Priority</th>
            <th>Status</th>
            <th>Team</th>
            <th>Actions</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="p : ${projects}">
            <td th:text="${p.name}"></td>
            <td th:text="${p.description}"></td>
            <td th:text="${p.priority}"></td>
            <td>
                <span th:text="${p.status}"></span>
                <!-- Manager: Can toggle status -->
                <form th:if="${isManager}" th:action="@{/projects/updateStatus}" method="post" class="d-inline ms-2">
                    <input type="hidden" name="projectId" th:value="${p.projectId}" />
                    <select name="status" class="form-select form-select-sm d-inline w-auto">
                        <option th:each="s : ${T(five.ind.ems_mvc.entity.enums.ProjectStatus).values()}" th:value="${s}" th:text="${s}" th:selected="${p.status == s}"></option>
                    </select>
                    <button type="submit" class="btn btn-sm btn-secondary ms-1">Update</button>
                </form>
            </td>
            <td>
                <span th:text="${p.team != null ? p.team.name : 'No Team Assigned'}"></span>
                <!-- Manager: Assign team if none -->
                <form th:if="${isManager} and (${p.team == null}) and ${allTeams != null}" th:action="@{/projects/{projectId}/assign(projectId=${p.projectId})}" method="post" class="mt-2">
                    <select name="teamId" class="form-select form-select-sm d-inline w-auto" required>
                        <option value="" disabled selected>Assign Team</option>
                        <option th:each="t : ${allTeams}" th:value="${t.teamId}" th:text="${t.name}"></option>
                    </select>
                    <button type="submit" class="btn btn-sm btn-primary ms-1">Assign</button>
                </form>
            </td>
            <td>
                <!-- Employee: View Tasks for their assigned team -->
                <a th:if="${!isManager} and ${employee != null} and ${employee.team != null} and (${p.team != null} and (${p.team.teamId} == ${employee.team.teamId}))"
                   th:href="@{/tasks/project/{id}(id=${p.projectId})}"
                   class="btn btn-sm btn-primary">View Tasks</a>
                <span th:if="${!isManager} and (${employee == null} or ${employee.team == null} or ${p.team == null} or (${p.team.teamId} != ${employee.team.teamId}))"
                      class="text-muted">Not Assigned</span>
            </td>
        </tr>
        </tbody>
    </table>
    <div th:if="${#lists.isEmpty(projects)}" class="alert alert-info">
        No projects found.
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
